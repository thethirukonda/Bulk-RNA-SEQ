---
title: "rnaseq"
author: "Aakash Deva Thirukonda Prakash"
date: "2025-12-10"
output: html_document
---

```{r}
getwd()
setwd("/Users/aakash/Downloads/rnaseq/quants/")  # to have all results at this path

#install.packages("BiocManager")
#BiocManager::install(version = "3.22")
#BiocManager::install("DESeq2")
install.packages("ggrepel")
library(ggrepel)
```
```{r}
## preparing counts and metadata
library(DESeq2)
library(dplyr)
library(tibble)
library(ggrepel)

# Fix 1: Use FULL file path
raw_counts <- read.csv("/Users/aakash/Downloads/rnaseq/quants/counts_matrix.csv", 
                       header = TRUE, row.names = "Geneid", stringsAsFactors = FALSE)

# Check it loaded correctly
head(raw_counts)
dim(raw_counts)  # Should be 78899 x 8

# Sort columns alphabetically
raw_counts <- raw_counts[, sort(colnames(raw_counts))]
colnames(raw_counts)  # Check the new order
colSums(raw_counts)

# Fix 2: Update condition to match YOUR sample order after sorting
# After sorting, your order will be:
# LNCAP_Hypoxia_S1, LNCAP_Hypoxia_S2, LNCAP_Normoxia_S1, LNCAP_Normoxia_S2,
# PC3_Hypoxia_S1, PC3_Hypoxia_S2, PC3_Normoxia_S1, PC3_Normoxia_S2

condition <- c(rep("LNCAP_Hypoxia", 2), 
               rep("LNCAP_Normoxia", 2), 
               rep("PC3_Hypoxia", 2), 
               rep("PC3_Normoxia", 2))
print(condition)

# Create metadata
my_colData <- as.data.frame(condition)
rownames(my_colData) <- colnames(raw_counts)
head(my_colData)
```
#Creating dds object 
```{r}
dds <- DESeqDataSetFromMatrix(countData = raw_counts,
                              colData = my_colData,
                              design = ~condition)
dds
head(counts(dds))
dim(counts(dds))
```
```{r}
count_matrix <- counts(dds)
dim(count_matrix)
zero_counts_per_gene <- rowSums(count_matrix == 0)
count_matrix <- as.data.frame(count_matrix)
zero_summary <- table(zero_counts_per_gene)
print(zero_summary)
```
```{r}
library(data.table)
library(dplyr)

setwd("/Users/aakash/Downloads/rnaseq")

# Load annotation
annotation <- fread("quants/GRCh38annotation.csv", stringsAsFactors = FALSE)

# Rename in the CORRECT order (ID, Type, Name)
colnames(annotation) <- c("Geneid", "Genebiotype", "Genesymbol")

# Verify
head(annotation)

# Load count matrix
counts_gse <- read.csv("quants/counts_matrix.csv",
                       header = TRUE,
                       stringsAsFactors = FALSE)

# Remove version numbers
counts_gse$Geneid <- sub("\\..*$", "", counts_gse$Geneid)
annotation$Geneid <- sub("\\..*$", "", annotation$Geneid)

# Merge
annotated_counts <- left_join(counts_gse, annotation, by = "Geneid") %>%
  select(Geneid, Genesymbol, Genebiotype, 
         LNCAP_Hypoxia_S1, LNCAP_Hypoxia_S2, 
         LNCAP_Normoxia_S1, LNCAP_Normoxia_S2, 
         PC3_Hypoxia_S1, PC3_Hypoxia_S2, 
         PC3_Normoxia_S1, PC3_Normoxia_S2)

# Check results
cat("Total genes:", nrow(annotated_counts), "\n")
cat("Genes with annotation:", sum(!is.na(annotated_counts$Genebiotype)), "\n")
cat("Genes with NA:", sum(is.na(annotated_counts$Genebiotype)), "\n")

head(annotated_counts, 20)

# Save
write.csv(annotated_counts, "annotated_counts_with_symbols.csv", row.names = FALSE)
cat("Success!\n") 
```
```{r}
biotypes_to_keep <- c("protein_coding", "IG_J_gene", "IG_V_gene", "IG_C_gene", "IG_D_gene", "TR_D_gene", "TR_C_gene", "TR_V_gene", "TR_J_gene")

filtered_counts <- annotated_counts %>%
  filter(Genebiotype %in% biotypes_to_keep)

filtered_counts$Geneid <- sub("\\..*$", "", filtered_counts$Geneid)
head(filtered_counts, n = 3)

output_file <- "9biotype_count_matrix.csv"
fwrite(filtered_counts, file = output_file, sep = ",", row.names = FALSE)
zero_counts1 <- rowSums(filtered_counts[, 4:11] == 0)
zero_summary2 <- table(zero_counts1)
print(zero_summary2)

############## filtering 2 steps
keep_genes <- zero_counts1 < 7
filtered_counts_nozero <- filtered_counts[keep_genes, ]
cat("Number of genes after filtering (zeros in <7 samples):", nrow(filtered_counts_nozero), "\n")

new_zero_counts <- rowSums(filtered_counts_nozero[, 4:11] == 0)
cat("New zero counts distribution:\n")
print(table(new_zero_counts))

output_file <- "filtered_biotype_nozero_count_matrix.csv"
fwrite(filtered_counts_nozero, file = output_file, sep = ",", row.names = FALSE)

head(filtered_counts_nozero, n = 3)

dds_filtered <- dds[rownames(dds) %in% filtered_counts_nozero$Geneid, ]
cat("Dimensions of filtered DESeqDataSet:", dim(dds_filtered), "\n")

removed_genes <- filtered_counts[!keep_genes, ]
cat("Biotype distribution of removed genes:\n")
print(table(removed_genes$Genebiotype))
```
```{r}
print(colnames(filtered_counts))
zero_counts <- rowSums(filtered_counts[, 4:11] == 0)
zero_summary <- table(zero_counts)
print(zero_summary)
keep_genes <- zero_counts < 7
filtered_counts_nozero <- filtered_counts[keep_genes, ]
cat("Number of genes after filtering (zeros in <7 samples):", nrow(filtered_counts_nozero), "\n")

new_zero_counts <- rowSums(filtered_counts_nozero[, 4:11] == 0)
print(table(new_zero_counts))

output_file <- "filtered_biotype_6.csv"
fwrite(filtered_counts_nozero, file = output_file, sep = ",", row.names = FALSE)

head(filtered_counts_nozero, n = 3)

dds_filtered <- dds[rownames(dds) %in% filtered_counts_nozero$Geneid, ]
```

```{r}
library(dplyr)

biotype_counts <- filtered_counts_nozero %>%
  dplyr::count(Genebiotype) %>%
  dplyr::mutate(Proportion = n / sum(n),
         Percentage = Proportion * 100) %>%
  dplyr::rename(Biotype = Genebiotype)  # Rename for clarity in plot
print(biotype_counts)

library(ggplot2)
p <- ggplot(biotype_counts, aes(x = reorder(Biotype, -Proportion), y = Proportion, fill = Biotype)) +
  geom_bar(stat = "identity") +
  labs(title = "Proportion of Genes by Biotype",
       x = "Gene Biotypes",
       y = "Proportion") +
  scale_y_continuous(labels = scales::percent_format(scale = 100)) +  # Show proportions as percentages
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
        legend.position = "none") +  # Remove legend if biotypes are clear
  scale_fill_brewer(palette = "Set2")  # Use distinct colors
p
output_plot <- "genebiotype_proportions1.png"
ggsave(output_plot, plot = p, width = 8, height = 6, dpi = 300)
```
```{r}
vsd <- vst(dds_filtered, blind = TRUE)  # blind=TRUE for exploratory PCA
plot_PCA = function (vsd.obj) {
  pcaData <- plotPCA(vsd.obj,  intgroup = c("condition"), returnData = T)
  percentVar <- round(100 * attr(pcaData, "percentVar"))
  ggplot(pcaData, aes(PC1, PC2, color=condition)) +
    geom_point(size=3) +
    labs(x = paste0("PC1: ",percentVar[1],"% variance"),
         y = paste0("PC2: ",percentVar[2],"% variance"),
         title = "PCA Plot colored by condition") +
    ggrepel::geom_text_repel(aes(label = name), color = "black")
}

png(filename = "pcab.png", 
    width = 2000, height = 2000, res = 300)  # adjust width/height as needed
plot_PCA(vsd)
dev.off()
```
```{r}
dds <- DESeq(dds_filtered)
dds
normalized_counts <- counts(dds, normalized = T)
normalized_counts_df <- as.data.frame(normalized_counts)
write.csv(normalized_counts_df, file = "normalized_counts.csv", row.names = TRUE)
```
```{r}
# Test 1: Can you create vsd?
vsd <- vst(dds_filtered, blind = TRUE)
print("vsd created successfully")

# Test 2: Can you call the PCA function?
pcaData <- plotPCA(vsd, intgroup = c("condition"), returnData = TRUE)
print("PCA data created successfully")

# Test 3: Check annotation structure
head(annotation)
colnames(annotation)
```
```{r}
vsd <- vst(dds, blind = TRUE)  # blind=TRUE for exploratory PCA
plot_PCA = function (vsd.obj) {
  pcaData <- plotPCA(vsd.obj,  intgroup = c("condition"), returnData = T)
  percentVar <- round(100 * attr(pcaData, "percentVar"))
  ggplot(pcaData, aes(PC1, PC2, color=condition)) +
    geom_point(size=3) +
    labs(x = paste0("PC1: ",percentVar[1],"% variance"),
         y = paste0("PC2: ",percentVar[2],"% variance"),
         title = "PCA Plot colored by condition") +
    ggrepel::geom_text_repel(aes(label = name), color = "black")
}

png(filename = "pcaa.png", 
    width = 2000, height = 2000, res = 300)  # adjust width/height as needed
plot_PCA(vsd)
dev.off()


vsd <- vst(dds, blind = TRUE)
plotDists = function (vsd.obj) {
  sampleDists <- dist(t(assay(vsd.obj)))
  sampleDistMatrix <- as.matrix(sampleDists)
  rownames(sampleDistMatrix) <- paste(vsd.obj$condition)
  colors <- colorRampPalette(rev(RColorBrewer::brewer.pal(9, "Blues")))(55)
  pheatmap::pheatmap(sampleDistMatrix, clustering_distance_rows = sampleDists,  clustering_distance_cols = sampleDists, col = colors, fontsize_row = 4, fontsize_col = 4, fontsize_legend = 4, fontsize = 4)
}
png(filename = "sampleheatmap1.png", width = 1000, height = 900, res = 300)  # adjust width/height as needed
plotDists(vsd)
dev.off()

variable_gene_heatmap <- function (vsd.obj, num_genes = 500, annotation, title = "") {
  brewer_palette <- "RdBu"
  ramp <- colorRampPalette( RColorBrewer::brewer.pal(11, brewer_palette))
  mr <- ramp(256)[256:1]
  stabilized_counts <- assay(vsd.obj)
  row_variances <- rowVars(stabilized_counts)
  top_variable_genes <- stabilized_counts[order(row_variances, decreasing=T)[1:num_genes],]
  top_variable_genes <- top_variable_genes - rowMeans(top_variable_genes, na.rm=T)
  gene_names <- annotation$Gene.name[match(rownames(top_variable_genes), annotation$Gene.stable.ID)]
  rownames(top_variable_genes) <- gene_names
  coldata <- as.data.frame(vsd.obj@colData)
  coldata$sizeFactor <- NULL
  pheatmap::pheatmap(top_variable_genes, color = mr, annotation_col = coldata, fontsize_col = 8, fontsize_row = 250/num_genes, border_color = NA, main = title)
}

png(filename = "variable_gene_heatmap.png", 
    width = 1000, height = 1000, res = 300)  # adjust width/height as needed
variable_gene_heatmap(vsd, num_genes = 40, annotation = annotation)
dev.off()

dim(dds)
```
```{r}
dds_lncap <- dds_filtered[, grepl("LNCAP", colnames(dds_filtered))]
dds_lncap
dds_lncap$condition <- droplevels(dds_lncap$condition)
dds_lncap$condition <- relevel(dds_lncap$condition, ref = "LNCAP_Normoxia")
dds_lncap <- DESeq(dds_lncap)

res_lncap <- results(dds_lncap, contrast = c("condition", "LNCAP_Hypoxia", "LNCAP_Normoxia"))
res_lncap
summary(res_lncap)

# Order by p-value FIRST
reslncapOrdered <- res_lncap[order(res_lncap$padj), ]

# THEN use it
sum(reslncapOrdered$padj < 0.05, na.rm = TRUE)
head(reslncapOrdered)
summary(reslncapOrdered)

# Save results
write.csv(as.data.frame(reslncapOrdered), file = "DEGs_lncap.csv")

cat("Analysis complete!\n")
cat("Significant genes (padj < 0.05):", sum(reslncapOrdered$padj < 0.05, na.rm = TRUE), "\n")
```
```{r}
plotMA(res_lncap)
```
```{r}
res_df <- as.data.frame(reslncapOrdered)
res_df <- na.omit(res_df)
res_df$gene <- rownames(res_df)

res_df$regulation <- "Not Significant"
res_df$regulation[res_df$padj < 0.05 & res_df$log2FoldChange > 1] <- "Upregulated"
res_df$regulation[res_df$padj < 0.05 & res_df$log2FoldChange < -1] <- "Downregulated"

qp <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = regulation)) +
  geom_point(alpha = 0.6) +
  scale_color_manual(values = c("Upregulated" = "#FEA405", 
                                "Downregulated" = "purple", 
                                "Not Significant" = "gray")) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  annotate("text", x = min(res_df$log2FoldChange), y = -log2(0.05) + 0.5,
           label = "padj = 0.05", hjust = 0, size = 3) +
  theme_minimal() +
  labs(title = "Volcano Plot", 
       x = "Log2 Fold Change", 
       y = "-Log10 Adjusted P-Value") +
  theme(plot.title = element_text(hjust = 0.5))

v_plot <- "vp_lncap.png"
ggsave(v_plot, plot = qp, width = 8, height = 6, dpi = 300)
```

```{r}
library(pheatmap)
library(RColorBrewer)
library(DESeq2)
library(dplyr)

DE_gene_heatmap <- function(res, count_matrix, padj_cutoff = 0.0001, ngenes = 20) {
  # Generate the color palette
  brewer_palette <- "RdBu"
  ramp <- colorRampPalette(RColorBrewer::brewer.pal(11, brewer_palette))
  mr <- ramp(256)[256:1]  # Reversed palette (blue to red)
  
  # Convert DESeqResults to data frame and get significant genes
  significant_genes <- as.data.frame(res) %>%
    filter(padj < padj_cutoff) %>%
    arrange(desc(log2FoldChange)) %>%
    head(ngenes)
  
  # Extract count data for significant genes
  heatmap_values <- count_matrix[rownames(significant_genes), ]  # Use row names (Ensembl IDs)
  
  # Add gene symbols as row names (assuming res has gene_symbol; adjust if needed)
  if ("gene_symbol" %in% colnames(res)) {
    rownames(heatmap_values) <- res[rownames(significant_genes), "gene_symbol"]
  } else {
    rownames(heatmap_values) <- rownames(significant_genes)  # Use Ensembl IDs if no symbols
  }
  
  # Scale rows for heatmap (z-score normalization)
  heatmap_values <- t(scale(t(heatmap_values)))
  
  # Plot the heatmap using pheatmap
  p <- pheatmap::pheatmap(heatmap_values,
                          color = mr,
                          scale = "none",  # Already scaled
                          cluster_rows = TRUE,
                          cluster_cols = TRUE,
                          fontsize_col = 10,
                          fontsize_row = max(6, 200/ngenes),  # Minimum font size of 6
                          border_color = NA,
                          main = paste("Top", ngenes, "DE Genes (padj <", padj_cutoff, ")"))
  
  # Return the pheatmap object
  return(invisible(p))
}

# Get count matrix from dds_filtered
count_matrix <- assay(dds_filtered)

# Save to Mac path
png("/Users/aakash/Downloads/rnaseq/de_gene_heatmap.png",
    width = 800, height = 600, res = 150)
d <- DE_gene_heatmap(res_lncap, count_matrix, padj_cutoff = 0.001, ngenes = 30)
dev.off()

cat("Heatmap saved to de_gene_heatmap.png\n")
```
```{r}
# Get raw and VST-transformed counts
raw_counts <- assay(dds_filtered)
vst_counts <- assay(vsd)

# Save to Mac path
png("/Users/aakash/Downloads/rnaseq/density_plots_raw_vst.png",
    width = 4000, height = 4000, res = 300)

par(mfrow = c(4, 4), mar = c(3, 3, 2, 1))  # 4x4 grid layout

for (i in 1:8) {
  # Raw counts density
  plot(density(raw_counts[, i]),
       main = paste("Raw - Sample", colnames(raw_counts)[i]),
       xlab = "Expression",
       col = "red",
       lwd = 2,
       ylim = c(0, max(sapply(1:8, function(j) max(density(raw_counts[, j])$y, na.rm = TRUE))))
       )
  
  # VST counts density (next panel)
  plot(density(vst_counts[, i]),
       main = paste("VST - Sample", colnames(vst_counts)[i]),
       xlab = "Expression",
       col = "blue",
       lwd = 2,
       ylim = c(0, max(sapply(1:8, function(j) max(density(vst_counts[, j])$y, na.rm = TRUE))))
       )
}

dev.off()

cat("Density plots saved to density_plots_raw_vst.png\n")
```


